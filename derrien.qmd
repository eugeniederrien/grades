---
title: "Final Lab"
author: "Eug√©nie Derrien"
format: html
---

Link to the github repository : https://github.com/eugeniederrien/grades

```{r}
#| message: false
here::i_am("grades.Rproj")
library(here)
library(readr)
```

```{r}
#| message: false
library(ggplot2)
library(dplyr)
library(tidyr)
library(knitr)
library(lubridate)
```

## Question 1 

```{r}
#| message: false
courses <- read_csv(here("data", "courses.csv"))
```

## Question 2 

```{r}
#| message: false
courses <- courses %>%
  rename(
    identifier = course_id,
    `number of grades` = nb_grades
  ) %>%
  arrange(course)

kable(
  courses,
  caption = "Courses (sorted alphabetically)",
  align = "l"
)
```

## Question 3

```{r}
#| message: false
students <- read_delim(here("data", "students.csv"), 
                        col_types = cols(
                    id = col_integer(),
                    group = col_factor(),
                    birth_date = col_date(),
                    sex = col_factor()
                  ))
spec(students)

paste("The birth_date column of the students data frame is of class", class(students$birth_date)[1])

```

## Question 4 

```{r}
grades <- read_delim(here("data", "grades.csv"),
  delim = ":",
  na = "_", 
   col_types = cols(
                    id = col_integer()  #I load id as an integer since I did the same for students
  ))

spec(grades)

```

## Question 5

```{r}
ggplot(
  students %>%
    group_by(group) %>%
    summarise(n_students = n()) %>% 
    ungroup(),
  aes(x = group, y = n_students)
) +
  geom_col() +
  labs(
    title = "Number of Students per Group",
    x = "Group",
    y = "Number of Students"
  ) +
  theme_minimal()

```

## Question 6 

```{r}
ggplot(students %>%
  group_by(group, sex) %>%
  summarise(n_students = n()) %>%
  ungroup()
  , aes(x = group, y = n_students, fill = sex)) +
  geom_col() +
  labs(
    title = "Gender Balance per Group",
    x = "Group",
    y = "Number of Students",
    fill = "Sex"
  ) +
  scale_fill_discrete(labels = c("F" = "Female", "M" = "Male")) +
  theme_minimal()
```

## Question 7

```{r}
students <- students %>%
  mutate(age = round(time_length(today() - birth_date, unit = "year")))

ggplot(students, aes(x = age)) +
  geom_histogram(binwidth = 1, fill = "slateblue", color = "black") +
  labs(
    title = "Distribution of Students' Age",
    x = "Age (years)",
    y = "Number of Students"
  ) +
  theme_minimal()

```

## Question 8 

```{r}
median_age_per_group <- students %>%
  group_by(group) %>%
  summarise(median_age = as.integer(round(median(age)))) %>%  # We round the median to an integer
  ungroup()

typeof(median_age_per_group$median_age)

kable(median_age_per_group, caption = "Median Age of Students per Group", align = "l")

```


## Question 9 

```{r}
kable(students %>%
  group_by(group) %>%
  slice_max(order_by = age, n = 1, with_ties = FALSE) %>%
  ungroup() %>%
  select(id, sex, age, group) %>% 
  arrange(desc(age))
  , caption = "Oldest Student in Each Group", 
  align = "l")
```

## Question 10

```{r}
n_grades <- grades %>%
  filter(!is.na(grade)) %>%
  nrow()

paste("The data set contains", n_grades, "grades.")
```

## Question 11 

```{r}
grades_courses <- grades %>%
  left_join(courses, by = c("course_id" = "identifier"))

grades_courses_students <- grades_courses %>%
  left_join(students %>% select(id, group, sex), by = "id")

avg_grades <- grades_courses_students %>%
  filter(course == "Warfare and Diplomacy", !is.na(grade)) %>%
  group_by(group) %>%
  summarise(avg_grade = mean(grade)) %>%
  ungroup()

ggplot(avg_grades, aes(x = group, y = avg_grade)) +
  geom_col(fill = "steelblue") +
  labs(
    title = "Average Grade in 'Warfare and Diplomacy' by Group",
    x = "Group",
    y = "Average Grade"
  ) +
  theme_minimal()
```

## Question 12

```{r}
ggplot(grades_courses_students %>% filter(!is.na(grade)), 
       aes(x = factor(trimester), y = grade, fill = factor(trimester))) +
  geom_boxplot() +
  labs(
    title = "Distribution of Grades by Trimester",
    x = "Trimester",
    y = "Grade",
    fill = "Trimester"
  ) +
  theme_minimal()
```

## Question 13 

```{r}
grades_per_student <- grades_courses_students %>%
  filter(!is.na(grade)) %>%
  group_by(id, group, sex) %>%
  summarise(n_grades = n()) %>%
  ungroup()

grades_per_student %>%
  slice_tail(n = 5) %>%
  knitr::kable(caption = "Sample of number of grades per student")

summary_stats <- grades_per_student %>%
  summarise(
    min_grades = min(n_grades),
    max_grades = max(n_grades),
    avg_grades = round(mean(n_grades), 2),
    median_grades = median(n_grades)
  )

knitr::kable(summary_stats, caption = "Summary statistics of number of grades per student")
```

## Question 14

```{r}
ggplot(grades_courses_students %>%
  filter(!is.na(grade)) %>%
  group_by(id, sex) %>%
  summarise(n_grades = n()) %>%
  ungroup()
  , aes(x = sex, y = n_grades, fill = sex)) +
  geom_boxplot() +
  labs(
    title = "Distribution of Number of Grades by Sex",
    x = "Sex",
    y = "Number of Grades",
    fill = "Sex"
  ) +
  scale_fill_discrete(labels = c("F" = "Female", "M" = "Male")) +
  theme_minimal()

ggplot(grades_courses_students %>%
  filter(!is.na(grade)) %>%
  group_by(id, sex) %>%
  summarise(n_grades = n()) %>%
  ungroup(), aes(x = n_grades, fill = sex, color = sex)) +
  geom_density(alpha = 0.3) +
  labs(
    title = "Density of Number of Grades by Sex",
    x = "Number of Grades",
    y = "Density",
    fill = "Sex",
    color = "Sex"
  ) +
  scale_fill_discrete(labels = c("F" = "Female", "M" = "Male")) +
  scale_color_discrete(labels = c("F" = "Female", "M" = "Male")) +
  theme_minimal()
```

## Question 15 

```{r}
env_stewardship_grades <- grades_courses_students %>%
  filter(!is.na(grade), course == "Environmental Stewardship") %>%
  group_by(id, group) %>%
  summarise(n_grades = n()) %>%
  ungroup()

env_stewardship_grades %>%
  slice_tail(n = 5) %>%
  knitr::kable(caption = "Number of grades per student in 'Environmental Stewardship'", align = "l")
```

## Question 16 

```{r}
grades_distribution <- env_stewardship_grades %>%
  group_by(n_grades) %>%
  summarise(n_students = n()) %>%
  ungroup()

ggplot(grades_distribution, aes(x = n_grades, y = n_students)) +
  geom_col(fill = "steelblue") +
  labs(
    title = "Distribution of Number of Grades in 'Environmental Stewardship'",
    x = "Number of Grades",
    y = "Number of Students"
  ) +
  theme_minimal()
```

## Question 17

```{r}
ggplot(env_stewardship_grades, aes(x = factor(group), y = n_grades, fill = factor(group))) +
  geom_boxplot() +
  labs(
    title = "Number of Grades in 'Environmental Stewardship' by Group",
    x = "Group",
    y = "Number of Grades",
    fill = "Group"
  ) +
  theme_minimal()
```

##Question 18

```{r}
# We create a new database for environmental stewardship course that contains the variable sex
env_stewardship_grades2 <- grades_courses_students %>%
  filter(!is.na(grade), course == "Environmental Stewardship") %>%
  group_by(id, group, sex) %>%
  summarise(n_grades = n()) %>%
  ungroup()

ggplot(env_stewardship_grades2, aes(x = factor(group), y = n_grades, fill = sex)) +
  geom_boxplot(position = position_dodge(width = 0.8)) +  
  labs(
    title = "Number of Grades in 'Environmental Stewardship' by Group and Sex",
    x = "Group",
    y = "Number of Grades",
    fill = "Sex"
  ) +
  scale_fill_discrete(labels = c("F" = "Female", "M" = "Male")) +
  theme_minimal()
```

##Question 19 

```{r}
avg_grades_per_course <- grades_courses_students %>%
  filter(!is.na(grade)) %>%
  group_by(id, group, course, sex) %>%
  summarise(avg_grade = mean(grade), .groups = "drop")

avg_grades_wide <- avg_grades_per_course %>%
  pivot_wider(
    names_from = course,
    values_from = avg_grade
  )

avg_grades_wide %>%
  select(id, group, `Art and Symbolism`, `Astronomy and Celestial Navigation`) %>%
  slice_head(n = 5) %>%
  knitr::kable(caption = "Sample of average grades per student (2 courses shown)")
```


## Question 20

```{r}
ggplot(avg_grades_wide, 
       aes(x = `Astronomy and Celestial Navigation`, 
           y = `Warfare and Diplomacy`)) +
  geom_point(alpha = 0.6, color = "steelblue", size = 3) +
  geom_smooth(method = "lm", se = TRUE, color = "darkred", linetype = "dashed") +
  labs(
    title = "Average Grades: 'Warfare and Diplomacy' as a function of 'Astronomy and Celestial Navigation'",
    x = "Average Grade in Astronomy and Celestial Navigation",
    y = "Average Grade in Warfare and Diplomacy"
  ) +
  theme_minimal(base_size = 14)
```
There seems to be a very slight positive correlation between the average grades in Astronomy and Celestial Navigation and the average grades in Warfare and Diplomacy.


## Question 21

```{r}
correlation_by_group <- avg_grades_wide %>%
  group_by(group) %>%
  summarise(
    correlation = cor(
      `Social Organization and Governance`, 
      `Hunting and Gathering Skills`,
      use = "complete.obs"
    ),
    .groups = "drop"
  )

correlation_by_group %>%
  knitr::kable(caption = "Correlation between 'Social Organization and Governance' and 'Hunting and Gathering Skills' by group")
```

## Question 22 

```{r}
# The group with the most extreme correlation is group 13

ggplot(avg_grades_wide %>%
  filter(group == 13), 
       aes(x = `Hunting and Gathering Skills`, y = `Social Organization and Governance`)) +
  geom_point(alpha = 0.6, color = "steelblue", size = 3) +
  geom_smooth(method = "lm", se = TRUE, color = "darkred", linetype = "dashed") +
  labs(
    title = paste0("Social Organization and Governance as a function of Hunting and Gathering Skills in group 13"),
    x = "Average Grade in Hunting and Gathering Skills",
    y = "Average Grade in Social Organization and Governance"
  ) +
  theme_minimal(base_size = 14)
```
For group 13, there is a strong positive correlation between  the average grades in Astronomy and Celestial Navigation and the average grades in Warfare and Diplomacy.

## Question 23

```{r}
final_grades <- avg_grades_wide %>%
  rowwise() %>%
  mutate(final_grade = mean(c_across(-c(id, group, sex)), na.rm = TRUE)) %>% 
  ungroup() %>%
  select(id, group, sex, final_grade) %>%
  arrange(desc(final_grade))

final_grades %>%
  slice_head(n = 5) %>%
  knitr::kable(caption = "Top 5 students by final grade")
```

## Question 24 

```{r}
final_grades_summary <- final_grades %>%
  group_by(group) %>%
  summarise(
    mean_grade = mean(final_grade),
    median_grade = median(final_grade),
    sd_grade = sd(final_grade),
    n_students = n(),
    .groups = "drop"
  )

knitr::kable(final_grades_summary, caption = "Summary of Final Grades by Group")

ggplot(final_grades, aes(x = factor(group), y = final_grade, fill = factor(group))) +
  geom_violin(alpha = 0.6) +
  geom_boxplot(width = 0.1, fill = "white") +
  labs(
    title = "Final Grades by Group",
    x = "Group",
    y = "Final Grade",
    fill = "Group"
  ) +
  theme_minimal()
```

There is a bit of heterogeneity in the final grades between groups, with group 13 having the best mean final grade equal to 10.67 and, group 9 having the worst mean final grad, equal to 9.41. 

## Question 25

```{r}
ggplot(final_grades, aes(x = factor(group), y = final_grade, fill = sex)) +
  geom_violin(alpha = 0.6, position = position_dodge(width = 0.8)) +
  geom_boxplot(width = 0.1, fill = "white", position = position_dodge(width = 0.8)) +
  labs(
    title = "Final Grades by Group and Sex",
    x = "Group",
    y = "Final Grade",
    fill = "Sex"
  ) +
  scale_fill_discrete(labels = c("F" = "Female", "M" = "Male")) +
  theme_minimal()


final_grades_summary2 <- final_grades %>%
  group_by(group, sex) %>%
  summarise(
    mean_grade = mean(final_grade),
    median_grade = median(final_grade),
    sd_grade = sd(final_grade),
    n_students = n(),
    .groups = "drop"
  )

knitr::kable(final_grades_summary2, caption = "Summary of Final Grades by Group and Sex")
```

We observe that within each group, there is not a lot of heterogeneity in the final grades between men and women. 


## Question 26

```{r}
# Average grade per course is already in avg_grades_wide

# Average grade per trimester
avg_per_trimester <- grades_courses_students %>%
  filter(!is.na(grade)) %>%
  group_by(id, trimester) %>%
  summarise(trimester_avg = mean(grade), .groups = "drop")

# Determine if student passes

pass_year <- avg_grades_wide %>%
  rowwise() %>%
  mutate(
    min_course_grade = min(c_across(-c(id, group, sex)), na.rm = TRUE)
  ) %>%
  ungroup() %>%
  left_join(
    avg_per_trimester %>%
      group_by(id) %>%
      summarise(min_trimester_avg = min(trimester_avg), .groups = "drop"),
    by = "id"
  ) %>%
  mutate(pass = (min_course_grade >= 5) & (min_trimester_avg >= 10)) %>%
  rowwise() %>%
  mutate(final_grade = mean(c_across(-c(id, group, sex, min_course_grade, min_trimester_avg, pass)), na.rm = TRUE)) %>%
  ungroup() %>%
  select(id, group, final_grade, pass)
```

## Question 27 

```{r}
students_not_pass_high_grade <- pass_year %>%
  filter(!pass, final_grade >= 10) %>%
  summarise(n_students = n())

students_not_pass_high_grade %>%
  knitr::kable(caption = "Number of students who do not pass but have final grade >= 10")
```

## Question 28 

```{r}
pass_rate_group <- pass_year %>%
  group_by(group) %>%
  summarise(
    pass_rate = mean(pass) * 100,  # in percentage
    n_students = n(),
    .groups = "drop"
  )

ggplot(pass_rate_group, aes(x = factor(group), y = pass_rate, fill = factor(group))) +
  geom_col() +
  labs(
    title = "Pass Rate by Group",
    x = "Group",
    y = "Pass Rate (%)",
    fill = "Group"
  ) +
  theme_minimal(base_size = 14)
```

There is a lot of heterogeneity in the pass rate between groups. While 50% of students of group 13 passed, 0% of the students of group 9 passed !

## Question 29 

```{r}
course_failure_count <- avg_grades_per_course %>%
  filter(avg_grade < 5) %>%
  group_by(course) %>%
  summarise(n_students_fail = n(), .groups = "drop") %>%
  arrange(desc(n_students_fail))

most_responsible_course <- course_failure_count %>%
  slice_head(n = 1)

```
The course most responsible for student failure due to grades below 5 is Astronomy and Celestial Navigation. 

## Question 30

```{r}
pass_with_age <- pass_year %>%
  left_join(students %>% select(id, age), by = "id")

pass_rate_by_age <- pass_with_age %>%
  group_by(age) %>%
  summarise(pass_rate = mean(pass) * 100, n_students = n(), .groups = "drop")

ggplot(pass_rate_by_age, aes(x = age, y = pass_rate)) +
  geom_line(color = "steelblue", size = 1) +
  geom_point(color = "darkred", size = 2) +
  labs(
    title = "Success Rate as a Function of Student Age",
    x = "Age (years)",
    y = "Pass Rate (%)"
  ) +
  theme_minimal(base_size = 14)
```

